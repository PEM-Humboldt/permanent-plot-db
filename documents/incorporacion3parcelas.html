<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>incorporacion3parcelas</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="incorporacion3parcelas_files/libs/clipboard/clipboard.min.js"></script>
<script src="incorporacion3parcelas_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="incorporacion3parcelas_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="incorporacion3parcelas_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="incorporacion3parcelas_files/libs/quarto-html/popper.min.js"></script>
<script src="incorporacion3parcelas_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="incorporacion3parcelas_files/libs/quarto-html/anchor.min.js"></script>
<link href="incorporacion3parcelas_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="incorporacion3parcelas_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="incorporacion3parcelas_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="incorporacion3parcelas_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="incorporacion3parcelas_files/libs/bootstrap/bootstrap-16557772f30236eb62d2cbcde5841b6c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="ejemplo-de-incorporación-de-datos-a-la-base-de-datos-parcelas-lapaz" class="level1">
<h1>Ejemplo de incorporación de datos a la base de datos: parcelas LaPaz,</h1>
<p>Matitas, Plato Marius Bottin</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>DIR_DATA <span class="ot">&lt;-</span> <span class="st">"../../otherData/"</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir</span>(DIR_DATA)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] "Dryflor_Marius.txt"           "LaPaz.csv"                   
[3] "Matitas.csv"                  "Plato.csv"                   
[5] "TDF_taxonomicReference.RData"</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>encod<span class="ot">&lt;-</span>stringi<span class="sc">::</span><span class="fu">stri_enc_detect</span>(<span class="fu">paste0</span>(DIR_DATA,<span class="st">"/LaPaz.csv"</span>))[[<span class="dv">1</span>]]<span class="sc">$</span>Encoding[<span class="dv">1</span>]</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>plots<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"LaPaz"</span>,<span class="st">"Matitas"</span>,<span class="st">"Plato"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>parcelas<span class="ot">&lt;-</span><span class="fu">lapply</span>(<span class="fu">paste</span>(DIR_DATA,<span class="fu">paste</span>(plots,<span class="st">"csv"</span>,<span class="at">sep=</span><span class="st">"."</span>),<span class="at">sep=</span><span class="st">"/"</span>),read.csv,<span class="at">dec=</span><span class="st">","</span>,<span class="at">sep=</span><span class="st">";"</span>, <span class="at">fileEncoding=</span>encod)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(parcelas) <span class="ot">&lt;-</span> plots</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># corrección puntual: hay un "1" en las latitudes de LaPaz que no tiene sentido</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>parcelas<span class="sc">$</span>LaPaz<span class="sc">$</span>latitude_decimal[parcelas<span class="sc">$</span>LaPaz<span class="sc">$</span>latitude_decimal<span class="sc">==</span><span class="dv">1</span>]<span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>parcelas_tot <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">sum</span>(<span class="fu">sapply</span>(parcelas,nrow)),<span class="at">plot=</span><span class="fu">rep</span>(<span class="fu">names</span>(parcelas),<span class="fu">sapply</span>(parcelas,nrow)),<span class="fu">Reduce</span>(rbind, parcelas))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="connect-to-the-database" class="level2">
<h2 class="anchored" data-anchor-id="connect-to-the-database">Connect to the database</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>pp_bst <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbConnect</span>(RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(), <span class="at">dbname =</span> <span class="st">"pp_bst_col"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="methodology-and-variables" class="level2">
<h2 class="anchored" data-anchor-id="methodology-and-variables">Methodology and variables</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>def_unit <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbReadTable</span>(pp_bst, DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema =</span> <span class="st">"main"</span>, <span class="at">table=</span><span class="st">"def_unit"</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="st">"Number of individuals"</span> <span class="sc">%in%</span> def_unit<span class="sc">$</span>unit)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>def_var <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbReadTable</span>(pp_bst, DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema =</span> <span class="st">"main"</span>, <span class="at">table=</span><span class="st">"def_var"</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="st">"qt_int"</span> <span class="sc">%in%</span> def_var<span class="sc">$</span>name_var)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>def_method <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbReadTable</span>(pp_bst, DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema =</span> <span class="st">"main"</span>, <span class="at">table=</span><span class="st">"def_method"</span>))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="st">"Permanent plot 1 (to be defined)"</span> <span class="sc">%in%</span> def_method<span class="sc">$</span>method)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="spatial-data" class="level2">
<h2 class="anchored" data-anchor-id="spatial-data">Spatial data</h2>
<section id="sending-individual-coordinates" class="level3">
<h3 class="anchored" data-anchor-id="sending-individual-coordinates">Sending individual coordinates</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spData)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>To access larger datasets in this package, install the spDataLarge
package with: `install.packages('spDataLarge',
repos='https://nowosad.github.io/drat/', type='source')`</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>Linking to GEOS 3.13.0, GDAL 3.9.3, PROJ 9.4.1; sf_use_s2() is TRUE</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>CRS<span class="ot">&lt;-</span><span class="dv">3116</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>CRS_orig<span class="ot">&lt;-</span><span class="dv">4326</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>worldData<span class="ot">&lt;-</span>spData<span class="sc">::</span>world</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>colombia<span class="ot">&lt;-</span><span class="fu">st_geometry</span>(worldData[worldData<span class="sc">$</span>name_long<span class="sc">==</span><span class="st">"Colombia"</span>,]) <span class="sc">%&gt;%</span> <span class="fu">st_set_crs</span>(CRS_orig) <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(CRS)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>sf_parcelas<span class="ot">&lt;-</span><span class="fu">st_as_sf</span>(parcelas_tot[<span class="sc">!</span><span class="fu">is.na</span>(parcelas_tot<span class="sc">$</span>longitude_decimal) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(parcelas_tot<span class="sc">$</span>latitude_decimal), ], <span class="at">coords=</span><span class="fu">c</span>(<span class="st">"longitude_decimal"</span>,<span class="st">"latitude_decimal"</span>)) <span class="sc">%&gt;%</span> <span class="fu">st_set_crs</span>(CRS_orig) <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(CRS)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> sf_parcelas, <span class="at">dsn =</span> pp_bst, <span class="at">layer =</span> DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema =</span> <span class="st">"tmp"</span>, <span class="at">table =</span> <span class="st">"parcelas"</span>), <span class="at">delete_layer =</span> T)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>Note: method with signature 'DBIObject#sf' chosen for function 'dbDataType',
 target signature 'PqConnection#sf'.
 "PqConnection#ANY" would also be valid</code></pre>
</section>
<section id="building-the-plot-polygons" class="level3">
<h3 class="anchored" data-anchor-id="building-the-plot-polygons">Building the plot polygons</h3>
<p>En este caso particular tenemos que construir los objetos espaciales que se van a referenciar.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="st">WITH a AS(</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT plot,min(ST_X(geometry)) min_x,min(ST_Y(geometry)) min_y,max(ST_X(geometry)) max_x,max(ST_Y(geometry)) max_y</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM tmp.parcelas</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY plot </span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT plot,</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="st">  ST_Distance(ST_SetSrid(ST_MakePoint(min_x,min_y),3116), ST_SetSrid(ST_MakePoint(min_x,max_y),3116)) distSN,</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="st">  ST_Distance(ST_SetSrid(ST_MakePoint(min_x,min_y),3116), ST_SetSrid(ST_MakePoint(max_x,min_y),3116)) distWE</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="st">FROM a</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="st">;"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">plot</th>
<th style="text-align: right;">distsn</th>
<th style="text-align: right;">distwe</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Plato</td>
<td style="text-align: right;">99.70003</td>
<td style="text-align: right;">99.70035</td>
</tr>
<tr class="even">
<td style="text-align: left;">LaPaz</td>
<td style="text-align: right;">99.44691</td>
<td style="text-align: right;">99.20926</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Matitas</td>
<td style="text-align: right;">99.79035</td>
<td style="text-align: right;">99.70009</td>
</tr>
</tbody>
</table>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CREATE A TABLE WITH TEMPORARY OBJECTS FOR THE PROJECTS POLYGONS</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(RPostgres<span class="sc">::</span><span class="fu">dbExistsTable</span>(pp_bst,DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"tmp"</span>,<span class="at">table=</span><span class="st">"spatproject"</span>)))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>{RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,<span class="st">"DROP TABLE tmp.spatproject"</span>)}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,<span class="st">"</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="st">CREATE TABLE tmp.spatproject AS(</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="st">WITH a AS(</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT plot,min(ST_X(geometry)) min_x,min(ST_Y(geometry)) min_y,max(ST_X(geometry)) max_x,max(ST_Y(geometry)) max_y</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM tmp.parcelas</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY plot </span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT </span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="st">  plot,</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="st">  ST_SetSRID(ST_makePolygon(ST_MakeLine(ARRAY[st_makepoint(min_x,min_y),ST_MakePoint(min_x,max_y), ST_MakePoint(max_x,max_y), ST_MakePoint(max_x,min_y), ST_MakePoint(min_x,min_y)])),3116) geom</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="st">FROM a</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="st">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 3</code></pre>
</section>
<section id="building-the-subplot-spatial-objects" class="level3">
<h3 class="anchored" data-anchor-id="building-the-subplot-spatial-objects">Building the subplot spatial objects</h3>
<section id="defining-the-grid-function-in-plpsql" class="level4">
<h4 class="anchored" data-anchor-id="defining-the-grid-function-in-plpsql">Defining the grid function in PL/PSQL</h4>
<p>Creating the function to create grids as polygons (which we will use as subplots)</p>
<p><a href="https://gis.stackexchange.com/questions/16374/creating-regular-polygon-grid-in-postgis" class="uri">https://gis.stackexchange.com/questions/16374/creating-regular-polygon-grid-in-postgis</a></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,<span class="st">"</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="st">CREATE OR REPLACE FUNCTION public.makegrid_2d (</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="st">  bound_polygon public.geometry,</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="st">  grid_step integer,</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="st">  metric_srid integer = 28408 --metric SRID (this particular is optimal for the Western Russia)</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="st">RETURNS public.geometry AS</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="st">$body$</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="st">DECLARE</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="st">  BoundM public.geometry; --Bound polygon transformed to the metric projection (with metric_srid SRID)</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="st">  Xmin DOUBLE PRECISION;</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="st">  Xmax DOUBLE PRECISION;</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="st">  Ymax DOUBLE PRECISION;</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="st">  X DOUBLE PRECISION;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="st">  Y DOUBLE PRECISION;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="st">  sectors public.geometry[];</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="st">  i INTEGER;</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="st">BEGIN</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="st">  BoundM := ST_Transform($1, $3); --From WGS84 (SRID 4326) to the metric projection, to operate with step in meters</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="st">  Xmin := ST_XMin(BoundM);</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="st">  Xmax := ST_XMax(BoundM);</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="st">  Ymax := ST_YMax(BoundM);</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="st">  Y := ST_YMin(BoundM); --current sector's corner coordinate</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="st">  i := -1;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="st">  &lt;&lt;yloop&gt;&gt;</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="st">  LOOP</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="st">    IF (Y &gt; Ymax) THEN  --Better if generating polygons exceeds the bound for one step. You always can crop the result. But if not you may get not quite correct data for outbound polygons (e.g. if you calculate frequency per sector)</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="st">        EXIT;</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="st">    END IF;</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="st">    X := Xmin;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;&lt;xloop&gt;&gt;</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a><span class="st">    LOOP</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="st">      IF (X &gt; Xmax) THEN</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="st">          EXIT;</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="st">      END IF;</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="st">      i := i + 1;</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="st">      sectors[i] := ST_GeomFromText('POLYGON(('||X||' '||Y||', '||(X+$2)||' '||Y||', '||(X+$2)||' '||(Y+$2)||', '||X||' '||(Y+$2)||', '||X||' '||Y||'))', $3);</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="st">      X := X + $2;</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="st">    END LOOP xloop;</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="st">    Y := Y + $2;</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="st">  END LOOP yloop;</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="st">  RETURN ST_Transform(ST_Collect(sectors), ST_SRID($1));</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="st">END;</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="st">$body$</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="st">LANGUAGE 'plpgsql';</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 0</code></pre>
</section>
<section id="using-the-plsql-function-to-create-the-polygon-grid" class="level4">
<h4 class="anchored" data-anchor-id="using-the-plsql-function-to-create-the-polygon-grid">Using the PL/SQL function to create the polygon grid</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(RPostgres<span class="sc">::</span><span class="fu">dbExistsTable</span>(pp_bst, DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"tmp"</span>,<span class="at">table=</span><span class="st">"spatevent"</span>)))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>   {RPostgres<span class="sc">::</span><span class="fu">dbRemoveTable</span>(pp_bst,DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"tmp"</span>,<span class="at">table=</span><span class="st">"spatevent"</span>))}</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="st">"CREATE TABLE tmp.spatevent AS(</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="st">WITH a AS(</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT plot,min(ST_X(geometry)) min_x,min(ST_Y(geometry)) min_y,max(ST_X(geometry)) max_x,max(ST_Y(geometry)) max_y</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM tmp.parcelas</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="st">    GROUP BY plot </span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="st">), b AS(</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT plot,ST_SetSRID(ST_makePolygon(ST_MakeLine(ARRAY[st_makepoint(min_x,min_y),ST_MakePoint(min_x,max_y), ST_MakePoint(max_x,max_y), ST_MakePoint(max_x,min_y), ST_MakePoint(min_x,min_y)])),3116) geom</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="st">FROM a</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="st">), c AS(</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT plot, (ST_dump(public.makegrid_2d(ST_Transform(geom,3116),10,3116))).*</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="st">FROM b</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="st">), d AS(</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT plot, path, ROUND(ST_X(ST_Centroid(geom))) x_round, ROUND(ST_Y(ST_CENTROID(geom))) y_round</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="st">FROM c</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="st">), e AS(</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT x_round, RANK() OVER (PARTITION BY plot ORDER BY x_round) rank_x</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="st">FROM d</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="st">GROUP BY plot,x_round</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="st">), f AS(</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT DISTINCT ON (y_round) y_round, RANK() OVER (PARTITION BY plot ORDER BY y_round) rank_y</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="st">FROM d</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="st">GROUP BY plot, y_round</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT d.plot, path, rank_x, rank_y,ST_Transform(geom,3116) geom</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="st">FROM d</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN e USING (x_round)</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN f USING (y_round)</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN c USING (plot,path)</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="st">ORDER BY plot, path</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="st">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 300</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>max_x<span class="ot">&lt;-</span><span class="dv">10</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>max_y<span class="ot">&lt;-</span><span class="dv">10</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">paste0</span>(<span class="st">"DELETE FROM tmp.spatevent</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE rank_x &gt; "</span>,max_x,<span class="st">" OR rank_y &gt; "</span>,max_y))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 0</code></pre>
<section id="subplot" class="level5">
<h5 class="anchored" data-anchor-id="subplot">subplot</h5>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>orderedSubplot<span class="ot">&lt;-</span><span class="fu">data.frame</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">rank_x =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>max_x,max_y),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">rank_y =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>max_y,<span class="at">each=</span>max_x),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">subplot =</span> <span class="cn">NA</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>counter<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">1</span>,max_x,<span class="at">by=</span><span class="dv">2</span>))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>max_y)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    counter<span class="ot">&lt;-</span>counter<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    orderedSubplot<span class="sc">$</span>subplot[orderedSubplot<span class="sc">$</span>rank_x<span class="sc">==</span>i <span class="sc">&amp;</span> orderedSubplot<span class="sc">$</span>rank_y<span class="sc">==</span>j]<span class="ot">&lt;-</span>counter</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  i<span class="ot">&lt;-</span>i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> max_y<span class="sc">:</span><span class="dv">1</span>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    counter<span class="ot">&lt;-</span>counter<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    orderedSubplot<span class="sc">$</span>subplot[orderedSubplot<span class="sc">$</span>rank_x<span class="sc">==</span>i <span class="sc">&amp;</span> orderedSubplot<span class="sc">$</span>rank_y<span class="sc">==</span>j]<span class="ot">&lt;-</span>counter</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> pp_bst, <span class="at">name =</span> DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"tmp"</span>,<span class="at">table=</span><span class="st">"subplotorder"</span>), <span class="at">value =</span> orderedSubplot, <span class="at">overwrite=</span>T)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst, <span class="st">"ALTER TABLE tmp.spatevent ADD COLUMN IF NOT EXISTS subplot int"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 0</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst, <span class="st">"UPDATE tmp.spatevent se SET subplot=spo.subplot FROM tmp.subplotorder spo WHERE se.rank_x=spo.rank_x AND se.rank_y=spo.rank_y"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 300</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>comp<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT p.subplot pt, se.subplot spat</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="st">FROM tmp.parcelas p</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN tmp.spatevent se ON ST_Intersects(p.geometry,se.geom)</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE p.plot='LaPaz'"</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(comp<span class="sc">$</span>pt<span class="sc">==</span>comp<span class="sc">$</span>spat)<span class="sc">/</span><span class="fu">nrow</span>(comp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 0.9751553</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>comp<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT p.subplot pt, se.subplot spat</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="st">FROM tmp.parcelas p</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN tmp.spatevent se ON ST_Intersects(p.geometry,se.geom)</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE p.plot='Matitas'"</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(comp<span class="sc">$</span>pt<span class="sc">==</span>comp<span class="sc">$</span>spat,<span class="at">na.rm =</span> T)<span class="sc">/</span><span class="fu">nrow</span>(comp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 0.9877255</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>comp<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT p.subplot pt, se.subplot spat</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="st">FROM tmp.parcelas p</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN tmp.spatevent se ON ST_Intersects(p.geometry,se.geom)</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE p.plot='Plato'"</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(comp<span class="sc">$</span>pt<span class="sc">==</span>comp<span class="sc">$</span>spat)<span class="sc">/</span><span class="fu">nrow</span>(comp)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 0.971345</code></pre>
</section>
</section>
</section>
<section id="inserting-locations" class="level3">
<h3 class="anchored" data-anchor-id="inserting-locations">Inserting locations</h3>
<section id="projects" class="level4">
<h4 class="anchored" data-anchor-id="projects">Projects</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst, <span class="st">"DELETE FROM main.location WHERE cd_loc IN (</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="st">                     SELECT COALESCE(d.cd_loc,c.cd_loc,b.cd_loc,a.cd_loc)</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="st">                     FROM tmp.spatproject sp</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="st">                     LEFT JOIN main.location a ON sp.plot=a.location</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="st">                     LEFT JOIN main.location b ON b.parent_loc=a.cd_loc</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="st">                     LEFT JOIN main.location c ON c.parent_loc=b.cd_loc</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="st">                     LEFT JOIN main.location d ON d.parent_loc=c.cd_loc</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="st">                     WHERE (a.location IN (SELECT plot FROM tmp.spatproject)</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="st">                     OR b.location IN (SELECT plot FROM tmp.spatproject)</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="st">                     OR c.location IN (SELECT plot FROM tmp.spatproject)</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="st">                     OR d.location IN (SELECT plot FROM tmp.spatproject)</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="st">                     )</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="st">)"</span>)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>          <span class="st">"INSERT INTO main.location(location,cd_loc_type,cd_org_lev,pol_geom)</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="st">          SELECT plot, cd_loc_type, cd_org_lev, ST_Transform(geom, (SELECT srid FROM geometry_columns WHERE f_geometry_column = 'pol_geom' AND f_table_name = 'location'))</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="st">          FROM tmp.spatproject</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="st">          CROSS JOIN (SELECT cd_loc_type FROM main.def_location_type WHERE location_type='Plot polygon') a</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="st">          CROSS JOIN (SELECT cd_org_lev FROM main.def_organisation_level WHERE org_lev='project') b</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="st">          "</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 3</code></pre>
</section>
<section id="events" class="level4">
<h4 class="anchored" data-anchor-id="events">Events</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="st">"INSERT INTO main.location(location, cd_loc_type, parent_loc, cd_org_lev, pol_geom)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT plot || ': subplot ' || subplot, a.cd_loc_type,l.cd_loc parent_loc, b.cd_org_lev, ST_Transform(se.geom, (SELECT srid FROM geometry_columns WHERE f_geometry_column = 'pol_geom' AND f_table_name = 'location'))</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="st">FROM tmp.spatevent se</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.location l ON se.plot=l.location</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="st">CROSS JOIN (SELECT cd_loc_type FROM main.def_location_type WHERE location_type='Plot polygon') a</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="st">CROSS JOIN (SELECT cd_org_lev FROM main.def_organisation_level WHERE org_lev='event') b</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="st">ORDER BY l.cd_loc,subplot</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 300</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,<span class="st">"DELETE FROM main.project WHERE project IN (SELECT plot FROM tmp.spatproject)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 0</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>          <span class="st">"INSERT INTO main.project(project, project_description,cd_proj_type,cd_method,cd_loc)</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="st">          SELECT plot,NULL,cd_proj_type,cd_method,cd_loc</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="st">          FROM tmp.spatproject sm</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="st">          CROSS JOIN (SELECT cd_proj_type FROM main.def_project_type WHERE proj_type='permanent plot') a</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="st">          CROSS JOIN (SELECT cd_method FROM main.def_method WHERE method='Permanent plot 1 (to be defined)') b</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="st">          LEFT JOIN main.location ON sm.plot=location</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="st">          "</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 3</code></pre>
</section>
</section>
</section>
<section id="inserting-gp_events" class="level2">
<h2 class="anchored" data-anchor-id="inserting-gp_events">Inserting gp_events</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>parcelas_tot<span class="sc">$</span>measuring_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(parcelas_tot<span class="sc">$</span>measuring_date, <span class="at">format=</span><span class="st">"%d/%m/%y"</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbWriteTable</span>(<span class="at">conn =</span> pp_bst, <span class="at">name =</span> DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"tmp"</span>,<span class="at">table=</span><span class="st">"completeplots"</span>), <span class="at">value =</span> parcelas_tot, <span class="at">overwrite =</span> T)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>(tab_gp_event<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(<span class="at">conn=</span>pp_bst, </span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="st">"WITH a AS(</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT DISTINCT cd_project, cd_loc, 'arbo' cd_gp_biol, a.cd_method, measuring_date date_begin, measuring_date date_end</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="st">FROM tmp.completeplots cp</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.project p ON p.project=cp.plot</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="st">CROSS JOIN (SELECT cd_method, method FROM main.def_method WHERE method='pp1_census0') a</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT a.*, ROW_NUMBER() OVER (PARTITION BY cd_project ORDER BY date_begin) AS compaign_nb</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="st">FROM a</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<table class="caption-top table">
<colgroup>
<col style="width: 14%">
<col style="width: 9%">
<col style="width: 14%">
<col style="width: 13%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">cd_project</th>
<th style="text-align: right;">cd_loc</th>
<th style="text-align: left;">cd_gp_biol</th>
<th style="text-align: right;">cd_method</th>
<th style="text-align: left;">date_begin</th>
<th style="text-align: left;">date_end</th>
<th style="text-align: right;">compaign_nb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">331</td>
<td style="text-align: right;">331</td>
<td style="text-align: left;">arbo</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">2015-11-08</td>
<td style="text-align: left;">2015-11-08</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">332</td>
<td style="text-align: right;">332</td>
<td style="text-align: left;">arbo</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">2015-10-21</td>
<td style="text-align: left;">2015-10-21</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">333</td>
<td style="text-align: right;">333</td>
<td style="text-align: left;">arbo</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">2015-11-07</td>
<td style="text-align: left;">2015-11-07</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">table</span>(tab_gp_event<span class="sc">$</span>cd_project)<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="st">"INSERT INTO main.gp_event(cd_project, cd_loc, cd_gp_biol, cd_method, date_begin, date_end, campaign_nb)</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="st">WITH a AS(</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT DISTINCT cd_project, cd_loc, 'arbo' cd_gp_biol, a.cd_method, measuring_date date_begin, measuring_date date_end</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="st">FROM tmp.completeplots cp</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.project p ON p.project=cp.plot</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="st">CROSS JOIN (SELECT cd_method, method FROM main.def_method WHERE method='pp1_census0') a</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT a.*, ROW_NUMBER() OVER (PARTITION BY cd_project ORDER BY date_begin) AS compaign_nb</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="st">FROM a</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 3</code></pre>
</section>
<section id="inserting-events" class="level2">
<h2 class="anchored" data-anchor-id="inserting-events">Inserting events</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst, </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="st">"WITH a AS(</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT p.project, cd_gp_event, date_begin date_gp_event</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM main.gp_event ge</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="st">  LEFT JOIN main.project p USING (cd_project)</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE p.project IN (SELECT plot FROM tmp.completeplots)</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="st">INSERT INTO main.event(event_id, cd_gp_event, num_replicate, description_replicate, date_begin, date_end, cd_loc)</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT project||'_census0_subplot'||subplot, cd_gp_event, subplot, 'subplot '||subplot||'/100', date_gp_event, date_gp_event, cd_loc</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="st">FROM a</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="st">CROSS JOIN (SELECT generate_series(1,100) subplot) b </span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.location ON location=a.project||': subplot '||b.subplot</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="st">ORDER BY cd_gp_event, subplot</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 300</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>events<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbReadTable</span>(pp_bst,DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"main"</span>,<span class="at">table=</span><span class="st">"event"</span>))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>m<span class="ot">&lt;-</span><span class="fu">match</span>(<span class="fu">paste0</span>(parcelas_tot<span class="sc">$</span>plot,<span class="st">"_census0_subplot"</span>,<span class="fu">trimws</span>(parcelas_tot<span class="sc">$</span>subplot)),events<span class="sc">$</span>event_id)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>parcelas_tot<span class="sc">$</span>cd_event<span class="ot">&lt;-</span>events<span class="sc">$</span>cd_event[m]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="correction-to-the-falsely-attribruted-subplots" class="level3">
<h3 class="anchored" data-anchor-id="correction-to-the-falsely-attribruted-subplots">Correction to the falsely attribruted subplots</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>sf_event <span class="ot">&lt;-</span> <span class="fu">st_read</span>(pp_bst,<span class="at">query=</span><span class="st">"</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT e.*,pol_geom</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="st">FROM main.project</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.gp_event ge USING (cd_project)</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.event e USING (cd_gp_event)</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.location l ON e.cd_loc=l.cd_loc</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE project IN ('LaPaz','Matitas','Plato')</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>sjpe <span class="ot">&lt;-</span> <span class="fu">st_join</span>(sf_parcelas,sf_event)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plato subparcelas 14 -&gt; 13</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>idToChange<span class="ot">&lt;-</span>sjpe<span class="sc">$</span>id[sjpe<span class="sc">$</span>plot<span class="sc">==</span><span class="st">"Plato"</span> <span class="sc">&amp;</span> sjpe<span class="sc">$</span>subplot<span class="sc">==</span><span class="dv">14</span> <span class="sc">&amp;</span> sjpe<span class="sc">$</span>num_replicate<span class="sc">==</span><span class="dv">13</span>]</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>newEvent <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"SELECT cd_event FROM main.event LEFT JOIN main.gp_event USING (cd_gp_event) LEFT JOIN main.project USING (cd_project) WHERE project='Plato' AND num_replicate=13"</span>)<span class="sc">$</span>cd_event</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>parcelas_tot[parcelas_tot<span class="sc">$</span>id <span class="sc">%in%</span> idToChange,<span class="st">"subplot"</span>]<span class="ot">&lt;-</span><span class="dv">13</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>parcelas_tot[parcelas_tot<span class="sc">$</span>id <span class="sc">%in%</span> idToChange,<span class="st">"cd_event"</span>]<span class="ot">&lt;-</span>newEvent</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plato subparcelas 45 -&gt; 44</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>idToChange<span class="ot">&lt;-</span>sjpe<span class="sc">$</span>id[sjpe<span class="sc">$</span>plot<span class="sc">==</span><span class="st">"Plato"</span> <span class="sc">&amp;</span> sjpe<span class="sc">$</span>subplot<span class="sc">==</span><span class="dv">45</span> <span class="sc">&amp;</span> sjpe<span class="sc">$</span>num_replicate<span class="sc">==</span><span class="dv">44</span>]</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>newEvent <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"SELECT cd_event FROM main.event LEFT JOIN main.gp_event USING (cd_gp_event) LEFT JOIN main.project USING (cd_project) WHERE project='Plato' AND num_replicate=44"</span>)<span class="sc">$</span>cd_event</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>parcelas_tot[parcelas_tot<span class="sc">$</span>id <span class="sc">%in%</span> idToChange,<span class="st">"subplot"</span>]<span class="ot">&lt;-</span><span class="dv">44</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>parcelas_tot[parcelas_tot<span class="sc">$</span>id <span class="sc">%in%</span> idToChange,<span class="st">"cd_event"</span>]<span class="ot">&lt;-</span>newEvent</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="inserting-projects" class="level2">
<h2 class="anchored" data-anchor-id="inserting-projects">Inserting projects</h2>
</section>
<section id="taxonomy" class="level2">
<h2 class="anchored" data-anchor-id="taxonomy">Taxonomy</h2>
<section id="getting-suggestions-and-validation-from-rdstaxval" class="level3">
<h3 class="anchored" data-anchor-id="getting-suggestions-and-validation-from-rdstaxval">Getting suggestions and validation from rdsTaxVal</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rdsTaxVal)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>taxo_parcelas<span class="ot">&lt;-</span><span class="fu">new_taxo_oneTab</span>(<span class="at">obj=</span>parcelas_tot,<span class="at">currentFormat =</span> <span class="st">"oneTable"</span>, <span class="at">taxonRanks_names =</span> <span class="fu">c</span>(<span class="at">family=</span><span class="st">"family"</span>,<span class="at">genus=</span><span class="st">"genus"</span>,<span class="at">species=</span><span class="st">"specificEpithet"</span>), <span class="at">taxonRanks_epithetized =</span> <span class="st">"specificEpithet"</span>,<span class="at">taxoCode =</span> <span class="cn">NA</span>, <span class="at">comments =</span> <span class="st">"comments"</span>,<span class="at">plot =</span> <span class="st">"plot"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>suggested_parcelas<span class="ot">&lt;-</span><span class="fu">fullTaxonomicDiagnostic</span>(taxo_parcelas,<span class="at">argsCheckFunction =</span> <span class="fu">list</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>cleaning space characters

misplaced qualifiers for undetermined taxa

unicity of genus in family

checking for unicity of taxonomic information associated with taxonomic code

Warning in checkUnicityCodetax(taxo = structure(list(id = 1:10422, plot =
c("LaPaz", : The taxonomic codes are not defined in the object, apply a check
on whether the taxonomic codes corresponds to taxonomic information does not
make sense

Comparing species information with gbif backbone

Searching for 76 taxa in the GBIF Backbone
...

done

Analysing GBIF Backbone information

64 taxa are found without any modification needed

1 taxa are found with suggested orthographic changes

11 taxa are suggested synonyms

2 taxa are found with suggested higher rank changes

0 taxa were not found

Comparing genus information with gbif backbone

Searching for 15 taxa in the GBIF Backbone
...

done

Analysing GBIF Backbone information

15 taxa are found without any modification needed

0 taxa are found with suggested orthographic changes

0 taxa are suggested synonyms

0 taxa are found with suggested higher rank changes

0 taxa were not found

Comparing family information with gbif backbone

Searching for 4 taxa in the GBIF Backbone
...

done

Analysing GBIF Backbone information

4 taxa are found without any modification needed

0 taxa are found with suggested orthographic changes

0 taxa are suggested synonyms

0 taxa are found with suggested higher rank changes

0 taxa were not found</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="ot">&lt;-</span><span class="fu">correct</span>(taxo_parcelas,suggested_parcelas)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>suggestTAB<span class="ot">&lt;-</span>suggested_parcelas<span class="sc">$</span>suggested</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Comparing with the TDF reference (the idea is that has already been reviewed in other validation run from other datasets)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"../../otherData/TDF_taxonomicReference.RData"</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>notInTdfRef<span class="ot">&lt;-</span><span class="fu">which</span>(<span class="sc">!</span><span class="fu">getLowerTax</span>(corrected_parcelas) <span class="sc">%in%</span> tdfTaxa<span class="sc">$</span>canonicalname)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>correctNotInTdfRef<span class="ot">&lt;-</span><span class="fu">intersect</span>(suggestTAB<span class="sc">$</span>row,notInTdfRef)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Los casos que corresponden a correcciones automáticas,que no resultan en taxones que ya se validaron en TDF y que no son simplemente “misplaced qualifiers”:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>kableExtra<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">unique</span>(suggestTAB[suggestTAB<span class="sc">$</span>row<span class="sc">%in%</span>correctNotInTdfRef <span class="sc">&amp;</span> <span class="sc">!</span>suggestTAB<span class="sc">$</span>suggestDescription<span class="sc">==</span><span class="st">"misplaced qualifiers for undetermined taxa"</span>,<span class="fu">c</span>(<span class="st">"suggestDescription"</span>,<span class="st">"family"</span>,<span class="st">"genus"</span>,<span class="st">"specificEpithet"</span>,<span class="st">"suggest_family"</span>,<span class="st">"suggest_genus"</span>,<span class="st">"suggest_specificEpithet"</span>,<span class="st">"suggest_verbatimTaxonRank"</span>)]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<table class="caption-top table">
<colgroup>
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: left;">suggestDescription</th>
<th style="text-align: left;">family</th>
<th style="text-align: left;">genus</th>
<th style="text-align: left;">specificEpithet</th>
<th style="text-align: left;">suggest_family</th>
<th style="text-align: left;">suggest_genus</th>
<th style="text-align: left;">suggest_specificEpithet</th>
<th style="text-align: left;">suggest_verbatimTaxonRank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">93</td>
<td style="text-align: left;">Comparing species information with gbif backbone (exactMatch_synonym)</td>
<td style="text-align: left;">Fabaceae</td>
<td style="text-align: left;">Piptadenia</td>
<td style="text-align: left;">flava</td>
<td style="text-align: left;">Fabaceae</td>
<td style="text-align: left;">Piptadenia</td>
<td style="text-align: left;">retusa</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">2292</td>
<td style="text-align: left;">Comparing species information with gbif backbone (exactMatch_synonym)</td>
<td style="text-align: left;">Euphorbiaceae</td>
<td style="text-align: left;">Croton</td>
<td style="text-align: left;">rhamnifolius</td>
<td style="text-align: left;">Euphorbiaceae</td>
<td style="text-align: left;">Mallotus</td>
<td style="text-align: left;">rhamnifolius</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2370</td>
<td style="text-align: left;">Comparing species information with gbif backbone (exactMatch_synonym_changeHigherRanks)</td>
<td style="text-align: left;">Boraginaceae</td>
<td style="text-align: left;">Bourreria</td>
<td style="text-align: left;">cumanensis</td>
<td style="text-align: left;">Ehretiaceae</td>
<td style="text-align: left;">Bourreria</td>
<td style="text-align: left;">exsucca</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">4500</td>
<td style="text-align: left;">Comparing species information with gbif backbone (fuzzyMatch_synonym)</td>
<td style="text-align: left;">Fabaceae</td>
<td style="text-align: left;">Lonchocarpus</td>
<td style="text-align: left;">sanctae-marthae</td>
<td style="text-align: left;">Fabaceae</td>
<td style="text-align: left;">Muellera</td>
<td style="text-align: left;">sanctae-marthae</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">8317</td>
<td style="text-align: left;">cleaning space characters -&gt; Comparing species information with gbif backbone (exactMatch_synonym)</td>
<td style="text-align: left;">Rhamnaceae</td>
<td style="text-align: left;">Ziziphus</td>
<td style="text-align: left;">saeri</td>
<td style="text-align: left;">Rhamnaceae</td>
<td style="text-align: left;">Sarcomphalus</td>
<td style="text-align: left;">saeri</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>completeClassifparcelas<span class="ot">&lt;-</span><span class="fu">extractCompleteTaxo</span>(suggested_parcelas<span class="sc">$</span>analysedGbif,<span class="at">addLocalId =</span> T,<span class="at">addAvailableAuthorship =</span> T, <span class="at">getUnavailableAuthorship =</span> T, <span class="at">getSynonyms =</span> T)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>finalTaxParcelas<span class="ot">&lt;-</span><span class="fu">getLowerTax</span>(corrected_parcelas)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>casesToAdd<span class="ot">&lt;-</span><span class="fu">extract</span>(corrected_parcelas,<span class="st">"taxonRanks"</span>)[<span class="sc">!</span><span class="fu">is.na</span>(finalTaxParcelas) <span class="sc">&amp;!</span>finalTaxParcelas <span class="sc">%in%</span> completeClassifparcelas<span class="sc">$</span>canonicalname,]</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">nrow</span>(casesToAdd)<span class="sc">==</span><span class="dv">0</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>completeClassifparcelas<span class="sc">$</span>parent_localId <span class="ot">&lt;-</span> completeClassifparcelas<span class="sc">$</span>localId[<span class="fu">match</span>(completeClassifparcelas<span class="sc">$</span>parent_gbifid , completeClassifparcelas<span class="sc">$</span>gbifid)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sending-taxonomy-to-the-database" class="level3">
<h3 class="anchored" data-anchor-id="sending-taxonomy-to-the-database">Sending taxonomy to the database</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RPostgres)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>pp_bst<span class="ot">&lt;-</span><span class="fu">dbConnect</span>(<span class="fu">Postgres</span>(),<span class="at">dbname=</span><span class="st">"pp_bst_col"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(pp_bst,<span class="st">"UPDATE main.taxo SET cd_accepted=cd_tax WHERE cd_accepted IS NULL"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 130</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>intoDB<span class="ot">&lt;-</span><span class="fu">addClassifToDb</span>(completeClassifparcelas, pp_bst)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>tax_localId <span class="ot">&lt;-</span> completeClassifparcelas<span class="sc">$</span>localId [ <span class="fu">match</span>(finalTaxParcelas, completeClassifparcelas<span class="sc">$</span>canonicalname) ]</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>correctedParcelas<span class="ot">&lt;-</span><span class="fu">addIdentifier</span>(corrected_parcelas,<span class="st">"tax_localId"</span>,<span class="at">nameID =</span> <span class="st">"Local taxon ID"</span>, <span class="at">typeID =</span> <span class="st">"local"</span>, <span class="at">nameSource =</span> <span class="st">"local R Session"</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>cd_tax <span class="ot">&lt;-</span> intoDB<span class="sc">$</span>final_cd_tax[<span class="fu">match</span>(corrected_parcelas<span class="sc">$</span>tax_localId, intoDB<span class="sc">$</span>localId)]</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="ot">&lt;-</span><span class="fu">addIdentifier</span>(corrected_parcelas,<span class="st">"cd_tax"</span>,<span class="at">nameID =</span> <span class="st">"Database taxon ID"</span>, <span class="at">typeID=</span><span class="st">"database"</span>, <span class="at">nameSource=</span><span class="st">"pp_bst_col"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="working-on-morpho-taxonomy" class="level3">
<h3 class="anchored" data-anchor-id="working-on-morpho-taxonomy">Working on morpho-taxonomy</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>mTax<span class="ot">&lt;-</span><span class="fu">getMorphoTaxo</span>(corrected_parcelas)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>w_mTax<span class="ot">&lt;-</span><span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(mTax))</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>mTax<span class="ot">&lt;-</span>mTax[w_mTax]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Morphotaxa need to be defined either for a project, a group of event or an event, here we will use the projects, which correspond to the plots.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>un_plots<span class="ot">&lt;-</span><span class="fu">unique</span>(corrected_parcelas<span class="sc">$</span>plot)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>un_cd_projects<span class="ot">&lt;-</span><span class="fu">unlist</span>(<span class="fu">sapply</span>(<span class="fu">paste0</span>(<span class="st">"SELECT cd_project FROM main.project WHERE project="</span>,RPostgres<span class="sc">::</span><span class="fu">dbQuoteString</span>(pp_bst,plots)),RPostgres<span class="sc">::</span>dbGetQuery, <span class="at">conn=</span>pp_bst, <span class="at">USE.NAMES =</span> F),<span class="at">use.names =</span> F)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>cd_projects<span class="ot">&lt;-</span>un_cd_projects[<span class="fu">match</span>(corrected_parcelas<span class="sc">$</span>plot,un_plots)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Morpho taxa must be defined with a type.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>getMorphoType<span class="ot">&lt;-</span><span class="cf">function</span>(taxo)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(methods<span class="sc">::</span><span class="fu">is</span>(taxo,<span class="st">"taxo_oneTab"</span>))</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  ATTR_mq <span class="ot">&lt;-</span> <span class="fu">attributes</span>(taxo)<span class="sc">$</span>morphoQualifiers</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  mqTab <span class="ot">&lt;-</span> <span class="fu">extract</span>(taxo, <span class="st">"morphoQualifiers"</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  nbQualifiers<span class="ot">&lt;-</span><span class="fu">apply</span>(mqTab, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(x)))</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(nbQualifiers<span class="sc">&gt;</span><span class="dv">1</span>))</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  {<span class="fu">stop</span>(<span class="st">"Some taxa have more than one qualifier (see extract(taxo, </span><span class="sc">\"</span><span class="st">morphoQualifiers</span><span class="sc">\"</span><span class="st">)"</span>)}</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  MT  <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_character_</span>, <span class="fu">nrow</span>(taxo) )</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">"sp_specif"</span> <span class="sc">%in%</span> <span class="fu">names</span>(ATTR_mq))</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    colSp_specif<span class="ot">&lt;-</span>ATTR_mq[<span class="st">"sp_specif"</span>]</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    MT[<span class="fu">grep</span>(<span class="st">"^spp?</span><span class="sc">\\</span><span class="st">.? *$"</span>,taxo[,colSp_specif])]<span class="ot">&lt;-</span><span class="st">"Unspecified species"</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    MT[<span class="fu">grep</span>(<span class="st">"^[Ss]p ?</span><span class="sc">\\</span><span class="st">.?[0-9]+"</span>,taxo[,colSp_specif])]<span class="ot">&lt;-</span><span class="st">"Numbered undetermined species"</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">any</span>(<span class="sc">!</span><span class="fu">is.na</span>(taxo[,colSp_specif]) <span class="sc">&amp;</span> <span class="fu">is.na</span>(MT))) {<span class="fu">warning</span>(<span class="st">"Undertermined morpho-taxa types"</span>)}</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="st">"cf_aff"</span> <span class="sc">%in%</span> <span class="fu">names</span>(ATTR_mq))</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    colCf_aff<span class="ot">&lt;-</span>ATTR_mq[<span class="st">"cf_aff"</span>]</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    MT[<span class="sc">!</span><span class="fu">is.na</span>(taxo[colCf_aff])]<span class="ot">&lt;-</span><span class="st">"Confere or affinity"</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(MT)</span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">getMorphoType</span>(corrected_parcelas))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>Numbered undetermined species           Unspecified species 
                          400                           185 </code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbExecute</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"DELETE FROM main.morfo_taxo WHERE def_for_project IN ("</span>,<span class="fu">paste</span>(un_cd_projects,<span class="at">collapse=</span><span class="st">","</span>),<span class="st">")"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 0</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>morphoToSend<span class="ot">&lt;-</span><span class="fu">unique</span>(<span class="fu">data.frame</span>(<span class="at">cd_tax=</span>corrected_parcelas<span class="sc">$</span>cd_tax,</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">morphotaxon_type=</span><span class="fu">getMorphoType</span>(corrected_parcelas),</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">name_morfo=</span><span class="fu">getMorphoTaxo</span>(corrected_parcelas),</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">pseudo_rank=</span><span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">"species"</span>,<span class="fu">getMorphoType</span>(corrected_parcelas)),<span class="st">"SP"</span>,<span class="cn">NA</span>),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">verbatim_taxon_rank=</span>corrected_parcelas<span class="sc">$</span>verbatimTaxonRank,</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">def_for_project=</span>cd_projects</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>           )[w_mTax,])</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="fu">dbAppendTable</span>(pp_bst,<span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"main"</span>,<span class="at">table=</span><span class="st">"morfo_taxo"</span>),morphoToSend)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 23</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>dbMT<span class="ot">&lt;-</span><span class="fu">dbReadTable</span>(pp_bst,<span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"main"</span>,<span class="at">table=</span><span class="st">"morfo_taxo"</span>))</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>dbToMatch<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(dbMT[<span class="fu">c</span>(<span class="st">"name_morfo"</span>,<span class="st">"def_for_project"</span>)])</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>localMT<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(<span class="fu">data.frame</span>(<span class="at">name_morfo=</span><span class="fu">getMorphoTaxo</span>(corrected_parcelas), <span class="at">def_for_project=</span>cd_projects))</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>cd_morfo<span class="ot">&lt;-</span>dbMT<span class="sc">$</span>cd_morfo[<span class="fu">match</span>(<span class="fu">split</span>(localMT,<span class="fu">row</span>(localMT)),<span class="fu">split</span>(dbToMatch,<span class="fu">row</span>(dbToMatch)))]</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co">#addIdentifier(corrected_parcelas,"cd_morfo",nameID = "Database Morphotaxon ID", typeID="Database",nameSource = "pp_bst_col")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="determination" class="level3">
<h3 class="anchored" data-anchor-id="determination">Determination</h3>
<p>Determinations make sense at the individual case. Here are the correspondance between rows and individuals:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">is.character</span>(corrected_parcelas<span class="sc">$</span>ind))</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>matInd<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(corrected_parcelas[<span class="fu">c</span>(<span class="st">"plot"</span>,<span class="st">"subplot"</span>,<span class="st">"ind"</span>)])</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>ind_idx<span class="ot">&lt;-</span><span class="fu">match</span>(<span class="fu">split</span>(matInd,<span class="fu">row</span>(matInd)),<span class="fu">split</span>(matInd,<span class="fu">row</span>(matInd)))</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>tax_ind<span class="ot">&lt;-</span><span class="fu">by</span>(corrected_parcelas,ind_idx,<span class="cf">function</span>(tab)<span class="fu">unique</span>(tab[<span class="fu">c</span>(<span class="st">"cd_tax"</span>,<span class="st">"cd_morfo"</span>)]))</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>un_taxInd<span class="ot">&lt;-</span><span class="fu">sapply</span>(tax_ind,nrow)<span class="sc">==</span><span class="dv">1</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="sc">!</span>un_taxInd)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] 25</code></pre>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>pb_ind<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">names</span>(un_taxInd)[<span class="sc">!</span>un_taxInd])</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(<span class="at">x =</span> corrected_parcelas[ind_idx <span class="sc">%in%</span> pb_ind,<span class="fu">c</span>(<span class="st">"plot"</span>,<span class="st">"subplot"</span>,<span class="st">"ind"</span>,<span class="st">"cd_tax"</span>,<span class="st">"cd_morfo"</span>,<span class="st">"genus"</span>,<span class="st">"specificEpithet"</span>,<span class="st">"verbatimTaxonRank"</span>)], <span class="at">file =</span> <span class="st">"../../problemIndividualTaxo.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>solution<span class="ot">&lt;-</span><span class="fu">read.csv</span>(<span class="st">"../../problemIndividualTaxo_soluciónNatalia.csv"</span>,<span class="at">sep=</span><span class="st">";"</span>, <span class="at">encoding =</span> <span class="st">"latin1"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>I’ve got a problem here: each time I apply the code from this document, the cd_morfo variable is deleted and created another time, which means that with the serial type, it increment the minimal values as the last max value +1. So it does not correspond.</p>
<p>The only solution is to test whether the tables have the same order and to replace</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(solution<span class="sc">$</span>cd_tax<span class="sc">==</span>corrected_parcelas<span class="sc">$</span>cd_tax[ind_idx <span class="sc">%in%</span> pb_ind])</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(solution<span class="sc">$</span>ind<span class="sc">==</span>corrected_parcelas<span class="sc">$</span>ind[ind_idx <span class="sc">%in%</span> pb_ind])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>solution<span class="sc">$</span>cd_morfo<span class="ot">&lt;-</span>corrected_parcelas<span class="sc">$</span>cd_morfo[ind_idx <span class="sc">%in%</span> pb_ind]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#solution$tagToChange&lt;- gsub("[A-z ]*([0-9]+\\.?[0-9]?[A-Z]?)$","\\1",solution$correccion)</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>matCorrec<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(solution[<span class="fu">c</span>(<span class="st">"plot"</span>,<span class="st">"subplot"</span>,<span class="st">"ind"</span>,<span class="st">"cd_tax"</span>,<span class="st">"cd_morfo"</span>)])</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>matCorrec[<span class="fu">grep</span>(<span class="st">"^ +"</span>,matCorrec)]<span class="ot">&lt;-</span><span class="fu">gsub</span>(<span class="st">"^ +"</span>,<span class="st">""</span>,matCorrec[<span class="fu">grep</span>(<span class="st">"^ +"</span>,matCorrec)])</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>matParcelas<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(corrected_parcelas[<span class="fu">c</span>(<span class="st">"plot"</span>,<span class="st">"subplot"</span>,<span class="st">"ind"</span>,<span class="st">"cd_tax"</span>,<span class="st">"cd_morfo"</span>)])</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>matParcelas[<span class="fu">grep</span>(<span class="st">"^ +"</span>,matParcelas)]<span class="ot">&lt;-</span><span class="fu">gsub</span>(<span class="st">"^ +"</span>,<span class="st">""</span>,matParcelas[<span class="fu">grep</span>(<span class="st">"^ +"</span>,matParcelas)])</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>m<span class="ot">&lt;-</span><span class="fu">match</span>(<span class="fu">split</span>(matCorrec,<span class="fu">row</span>(matCorrec)),<span class="fu">split</span>(matParcelas,<span class="fu">row</span>(matParcelas)))</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co">#m&lt;-match(split(matParcelas,row(matParcelas)),split(matCorrec,row(matCorrec)))</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>pbToResolve<span class="ot">&lt;-</span><span class="fu">unique</span>(ind_idx[m])</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>ind_idx_v2<span class="ot">&lt;-</span>ind_idx</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>min_new_idx<span class="ot">&lt;-</span><span class="fu">nrow</span>(corrected_parcelas) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(pbToResolve))</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  c_idx <span class="ot">&lt;-</span>pbToResolve[i]</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> solution[ind_idx[m]<span class="sc">==</span>c_idx,]</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> corrected_parcelas[ind_idx<span class="sc">==</span>c_idx,]</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="fu">nrow</span>(s)<span class="sc">==</span><span class="fu">nrow</span>(p))</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>  mt <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(p[<span class="fu">c</span>(<span class="st">"cd_tax"</span>, <span class="st">"cd_morfo"</span>)])</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>  m_mt <span class="ot">&lt;-</span> <span class="fu">match</span>(<span class="fu">split</span>(mt,<span class="fu">row</span>(mt)),<span class="fu">split</span>(mt,<span class="fu">row</span>(mt)))</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>  changeInd <span class="ot">&lt;-</span> s<span class="sc">$</span>correccion <span class="sc">!=</span> <span class="st">""</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(changeInd) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">sum</span>(changeInd)<span class="sc">==</span><span class="dv">1</span>) <span class="co"># If there is cases where more than one file should change individualID, the code should be more complex, understand if there are more than one row corresponding to the same individual etc.</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>    c_plot <span class="ot">&lt;-</span> s<span class="sc">$</span>plot[<span class="dv">1</span>]</span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>    c_subplot <span class="ot">&lt;-</span> s<span class="sc">$</span>subplot[<span class="dv">1</span>]</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>    c_ind <span class="ot">&lt;-</span> s<span class="sc">$</span>ind[<span class="dv">1</span>]</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>    potentialInd <span class="ot">&lt;-</span> <span class="fu">paste</span>(c_ind,<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>,<span class="at">sep=</span><span class="st">"."</span>)</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>    alreadyInd<span class="ot">&lt;-</span>corrected_parcelas<span class="sc">$</span>ind[corrected_parcelas<span class="sc">$</span>plot <span class="sc">==</span> c_plot <span class="sc">&amp;</span> corrected_parcelas<span class="sc">$</span>subplot <span class="sc">==</span> c_subplot]</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>    newInd<span class="ot">&lt;-</span>potentialInd[<span class="sc">!</span>potentialInd<span class="sc">%in%</span>alreadyInd][<span class="dv">1</span>]</span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>ind[ind_idx<span class="sc">==</span>c_idx][changeInd]<span class="ot">&lt;-</span>newInd</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>individualID[ind_idx<span class="sc">==</span>c_idx][changeInd]<span class="ot">&lt;-</span>newInd</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>ramet[ind_idx<span class="sc">==</span>c_idx][changeInd]<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>    ind_idx_v2[ind_idx<span class="sc">==</span>c_idx][changeInd]<span class="ot">&lt;-</span><span class="fu">max</span>(min_new_idx,<span class="fu">max</span>(ind_idx_v2)<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>    newIdxs<span class="ot">&lt;-</span>ind_idx_v2[ind_idx<span class="sc">==</span>c_idx]</span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>    resolved<span class="ot">&lt;-</span><span class="fu">all</span>(<span class="fu">tapply</span>(newIdxs,m_mt,<span class="cf">function</span>(x)<span class="fu">length</span>(<span class="fu">unique</span>(x)))<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">sum</span>(changeInd) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">||</span> (<span class="fu">sum</span>(changeInd)<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> <span class="sc">!</span>resolved))</span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopifnot</span>(<span class="fu">tapply</span>(s<span class="sc">$</span>selecci.n,m_mt,<span class="cf">function</span>(x)<span class="fu">length</span>(<span class="fu">unique</span>(x)))<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>    corr_family<span class="ot">&lt;-</span>p<span class="sc">$</span>family[s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>    corr_genus<span class="ot">&lt;-</span>p<span class="sc">$</span>genus[s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>    corr_specificEpithet<span class="ot">&lt;-</span>p<span class="sc">$</span>specificEpithet[s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>    corr_authorName<span class="ot">&lt;-</span>p<span class="sc">$</span>authorName[s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>    corr_cd_tax<span class="ot">&lt;-</span>p<span class="sc">$</span>cd_tax[s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>    corr_cd_morfo<span class="ot">&lt;-</span>p<span class="sc">$</span>cd_tax[s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>    corr_tax_localId<span class="ot">&lt;-</span>p<span class="sc">$</span>tax_localId[s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>    corr_verbatimTaxonRank<span class="ot">&lt;-</span>p<span class="sc">$</span>verbatimTaxonRank[s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">1</span>][<span class="dv">1</span>]</span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>family[ind_idx<span class="sc">==</span>c_idx][s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span>corr_family</span>
<span id="cb72-48"><a href="#cb72-48" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>genus[ind_idx<span class="sc">==</span>c_idx][s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span>corr_genus</span>
<span id="cb72-49"><a href="#cb72-49" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>specificEpithet[ind_idx<span class="sc">==</span>c_idx][s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span>corr_specificEpithet</span>
<span id="cb72-50"><a href="#cb72-50" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>authorName[ind_idx<span class="sc">==</span>c_idx][s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span>corr_authorName</span>
<span id="cb72-51"><a href="#cb72-51" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>cd_tax[ind_idx<span class="sc">==</span>c_idx][s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span>corr_cd_tax</span>
<span id="cb72-52"><a href="#cb72-52" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>cd_morpho[ind_idx<span class="sc">==</span>c_idx][s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span>corr_cd_morfo</span>
<span id="cb72-53"><a href="#cb72-53" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>tax_localId[ind_idx<span class="sc">==</span>c_idx][s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span>corr_tax_localId</span>
<span id="cb72-54"><a href="#cb72-54" aria-hidden="true" tabindex="-1"></a>    corrected_parcelas<span class="sc">$</span>verbatimTaxonRank[ind_idx<span class="sc">==</span>c_idx][s<span class="sc">$</span>selecci.n<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span>corr_verbatimTaxonRank</span>
<span id="cb72-55"><a href="#cb72-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-56"><a href="#cb72-56" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>There is a problem for various individuals which have more than one taxon depending on the ramet.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>majority<span class="ot">&lt;-</span><span class="cf">function</span>(mat)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  m<span class="ot">&lt;-</span><span class="fu">match</span>(<span class="fu">split</span>(mat,<span class="fu">row</span>(mat)),<span class="fu">split</span>(mat,<span class="fu">row</span>(mat)))</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.numeric</span>(<span class="fu">names</span>(<span class="fu">sort</span>(<span class="fu">table</span>(m),<span class="at">decreasing =</span> T))[<span class="dv">1</span>]))</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(<span class="fu">sapply</span>(tax_ind,<span class="cf">function</span>(x)<span class="fu">majority</span>(<span class="fu">as.matrix</span>(x)))<span class="sc">==</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<pre><code>[1] TRUE</code></pre>
</section>
</section>
<section id="inserting-determination-register-individual-and-coordinates" class="level2">
<h2 class="anchored" data-anchor-id="inserting-determination-register-individual-and-coordinates">Inserting determination, register, individual and coordinates</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>matInd<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(corrected_parcelas[<span class="fu">c</span>(<span class="st">"plot"</span>,<span class="st">"subplot"</span>,<span class="st">"ind"</span>)])</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>ind_idx<span class="ot">&lt;-</span><span class="fu">match</span>(<span class="fu">split</span>(matInd,<span class="fu">row</span>(matInd)),<span class="fu">split</span>(matInd,<span class="fu">row</span>(matInd)))</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>ind_tab<span class="ot">&lt;-</span>corrected_parcelas[<span class="fu">unique</span>(ind_idx),]</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>ind_tab<span class="sc">$</span>cd_project<span class="ot">&lt;-</span>cd_projects[<span class="fu">unique</span>(ind_idx)]</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>ind_tab<span class="sc">$</span>cd_identif<span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>ind_tab<span class="sc">$</span>cd_reg<span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>ind_tab<span class="sc">$</span>cd_ind<span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>dateIdentif<span class="ot">&lt;-</span><span class="fu">as.Date</span>(<span class="st">"1/10/2025"</span>,<span class="at">format=</span><span class="st">"%d/%m/%Y"</span>)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dbBegin</span>(pp_bst)</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ind_tab))</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  cd_identif <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"INSERT INTO main.identification (cd_tax, cd_morfo, date_identif) VALUES("</span>,</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>         <span class="fu">dbQuoteLiteral</span>(pp_bst,ind_tab<span class="sc">$</span>cd_tax[i]),<span class="st">","</span>,</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>         <span class="fu">dbQuoteLiteral</span>(pp_bst,ind_tab<span class="sc">$</span>cd_morfo[i]),<span class="st">","</span>,</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>         <span class="fu">dbQuoteLiteral</span>(pp_bst,dateIdentif),<span class="st">")</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="st">         RETURNING cd_identif"</span>)</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>  )<span class="sc">$</span>cd_identif</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>  cd_reg<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"INSERT INTO main.register(cd_event, cd_identif, date_reg, qt_int)</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="st">         VALUES("</span>,</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>         <span class="fu">dbQuoteLiteral</span>(pp_bst,ind_tab<span class="sc">$</span>cd_event[i]),<span class="st">","</span>,</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>         <span class="fu">dbQuoteLiteral</span>(pp_bst,cd_identif),<span class="st">","</span>,</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>         <span class="fu">dbQuoteLiteral</span>(pp_bst,ind_tab<span class="sc">$</span>measuring_date[i]),<span class="st">","</span>,</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>         <span class="dv">1</span>,<span class="st">")</span></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="st">         RETURNING cd_reg"</span>)</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>         )<span class="sc">$</span>cd_reg</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(ind_tab<span class="sc">$</span>latitude_decimal[i])<span class="sc">&amp;!</span><span class="fu">is.na</span>(ind_tab<span class="sc">$</span>longitude_decimal[i]))</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"INSERT INTO main.register_location</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="st">           VALUES("</span>,</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>           <span class="fu">dbQuoteLiteral</span>(pp_bst,cd_reg),<span class="st">","</span>,</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>           <span class="st">"ST_Transform(ST_SetSRID("</span>,</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>           <span class="st">"ST_MakePoint("</span>,<span class="fu">dbQuoteLiteral</span>(pp_bst,ind_tab<span class="sc">$</span>longitude_decimal[i]),<span class="st">","</span>,<span class="fu">dbQuoteLiteral</span>(pp_bst,ind_tab<span class="sc">$</span>latitude_decimal[i]),<span class="st">"),"</span>,<span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="fu">as.integer</span>(CRS_orig)),<span class="st">"),"</span>,<span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="fu">as.integer</span>(CRS)),<span class="st">"))"</span></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>           ))</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>   cd_ind<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"INSERT INTO main.individual(tag,uniq_in_project) VALUES(</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a><span class="st">         "</span>, <span class="fu">dbQuoteLiteral</span>(pp_bst,ind_tab<span class="sc">$</span>ind[i]),<span class="st">","</span>,<span class="co"># </span><span class="al">NOTE</span><span class="co"> THIS WILL NOT ALWAYS WORK, WE MAY HAVE TO EXTRACT THE individual code from the tag</span></span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>         <span class="fu">dbQuoteLiteral</span>(pp_bst,ind_tab<span class="sc">$</span>cd_project[i]),</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>         <span class="st">") RETURNING cd_ind"</span> </span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>         ))<span class="sc">$</span>cd_ind</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>  RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"INSERT INTO main.reg_individual VALUES("</span>,<span class="fu">dbQuoteLiteral</span>(pp_bst,cd_ind),<span class="st">","</span>,<span class="fu">dbQuoteLiteral</span>(pp_bst,cd_reg),<span class="st">")"</span>))</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>  ind_tab<span class="sc">$</span>cd_identif[i]<span class="ot">&lt;-</span>cd_identif</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>  ind_tab<span class="sc">$</span>cd_reg[i]<span class="ot">&lt;-</span>cd_reg</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>  ind_tab<span class="sc">$</span>cd_ind[i]<span class="ot">&lt;-</span>cd_ind</span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a><span class="fu">dbCommit</span>(pp_bst)</span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>m<span class="ot">&lt;-</span><span class="fu">match</span>(ind_idx,<span class="fu">unique</span>(ind_idx))</span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>cd_identif<span class="ot">&lt;-</span>ind_tab<span class="sc">$</span>cd_identif[m]</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>cd_reg<span class="ot">&lt;-</span>ind_tab<span class="sc">$</span>cd_reg[m]</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>cd_ind<span class="ot">&lt;-</span>ind_tab<span class="sc">$</span>cd_ind[m]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="inserting-subindividual" class="level2">
<h2 class="anchored" data-anchor-id="inserting-subindividual">Inserting subindividual</h2>
<p>Inserting the ramet subpart:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>subind_part <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbReadTable</span>(pp_bst,DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"main"</span>,<span class="at">table=</span><span class="st">"def_subindividual_part"</span>))</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="st">"ramet"</span> <span class="sc">%in%</span> subind_part<span class="sc">$</span>part)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  cd_part <span class="ot">&lt;-</span> subind_part<span class="sc">$</span>cd_part[subind_part<span class="sc">$</span>part<span class="sc">==</span><span class="st">"ramet"</span>]</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>  RPostgres<span class="sc">::</span><span class="fu">dbAppendTable</span>(pp_bst, DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"main"</span>,<span class="at">table=</span><span class="st">"def_subindividual_part"</span>),</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">data.frame</span>(</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>                             <span class="at">part =</span> <span class="st">"ramet"</span>,</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cd_gp_biol =</span><span class="st">"arbo"</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>                           ))</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>  subind_part <span class="ot">&lt;-</span> RPostgres<span class="sc">::</span><span class="fu">dbReadTable</span>(pp_bst,DBI<span class="sc">::</span><span class="fu">Id</span>(<span class="at">schema=</span><span class="st">"main"</span>,<span class="at">table=</span><span class="st">"def_subindividual_part"</span>))</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>  cd_part <span class="ot">&lt;-</span> subind_part<span class="sc">$</span>cd_part[subind_part<span class="sc">$</span>part<span class="sc">==</span><span class="st">"ramet"</span>]</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Inserting the variables</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>vars<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst, <span class="st">"SELECT cd_var,name_var,org_lev FROM main.def_var dv LEFT JOIN main.def_organisation_level USING (cd_org_lev);"</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(vars<span class="sc">$</span>name_var<span class="sc">==</span><span class="st">"dbh_cm"</span> <span class="sc">&amp;</span> vars<span class="sc">$</span>org_lev<span class="sc">==</span><span class="st">"sub-individual characteristics"</span>))</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  cd_var_dbh_cm <span class="ot">&lt;-</span> vars<span class="sc">$</span>cd_var[vars<span class="sc">$</span>name_var<span class="sc">==</span><span class="st">"dbh_cm"</span> <span class="sc">&amp;</span> vars<span class="sc">$</span>org_lev<span class="sc">==</span><span class="st">"sub-individual characteristics"</span>]</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span>{</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  units<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"SELECT cd_unit, unit, measurement_type FROM main.def_unit LEFT JOIN main.def_measurement_type USING (cd_measurement_type)"</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(units<span class="sc">$</span>unit<span class="sc">==</span><span class="st">"centimeter"</span> <span class="sc">&amp;</span> units<span class="sc">$</span>measurement_type<span class="sc">==</span><span class="st">"length"</span>))</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  {cd_unit_cm<span class="ot">&lt;-</span>units<span class="sc">$</span>cd_unit[units<span class="sc">$</span>unit<span class="sc">==</span><span class="st">"centimeter"</span> <span class="sc">&amp;</span> units<span class="sc">$</span>measurement_type<span class="sc">==</span><span class="st">"length"</span>]</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>    cd_unit_cm<span class="ot">&lt;-</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"INSERT INTO main.def_unit(cd_measurement_type,unit,unit_spa,abbv_unit,factor)</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="st">VALUES((SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type = 'length')"</span>,<span class="st">","</span>,</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"centimeter"</span>),<span class="st">","</span>,</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"centímetro"</span>),<span class="st">","</span>,</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"cm"</span>),<span class="st">","</span>,</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="fl">0.001</span>),</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a><span class="st">") RETURNING cd_unit"</span>))<span class="sc">$</span>cd_unit</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  cd_var_dbh_cm<span class="ot">&lt;-</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"INSERT INTO main.def_var(cd_unit,cd_org_lev,name_var,description,extra_var,extension_dwc,type_var,repeatable) VALUES("</span>,</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,cd_unit_cm),<span class="st">",</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a><span class="st">(SELECT cd_org_lev FROM main.def_organisation_level WHERE org_lev='sub-individual characteristics'),"</span>,</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"dbh_cm"</span>),<span class="st">","</span>,</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"Diameter at breast height"</span>),<span class="st">","</span>,</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,T),<span class="st">","</span>,</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">'MeasurementOrFact'</span>),<span class="st">","</span>,</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"double precision"</span>),<span class="st">","</span>,</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,F),<span class="st">")</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a><span class="st">RETURNING cd_var"</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>    ))<span class="sc">$</span>cd_var</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(vars<span class="sc">$</span>name_var<span class="sc">==</span><span class="st">"height_m"</span> <span class="sc">&amp;</span> vars<span class="sc">$</span>org_lev<span class="sc">==</span><span class="st">"sub-individual characteristics"</span>))</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>  cd_var_height_m <span class="ot">&lt;-</span> vars<span class="sc">$</span>cd_var[vars<span class="sc">$</span>name_var<span class="sc">==</span><span class="st">"height_m"</span> <span class="sc">&amp;</span> vars<span class="sc">$</span>org_lev<span class="sc">==</span><span class="st">"sub-individual characteristics"</span>]</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span>{</span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>  units<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"SELECT cd_unit, unit, measurement_type FROM main.def_unit LEFT JOIN main.def_measurement_type USING (cd_measurement_type)"</span>)</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(units<span class="sc">$</span>unit<span class="sc">==</span><span class="st">"meter"</span> <span class="sc">&amp;</span> units<span class="sc">$</span>measurement_type<span class="sc">==</span><span class="st">"length"</span>))</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>  {cd_unit_m<span class="ot">&lt;-</span>units<span class="sc">$</span>cd_unit[units<span class="sc">$</span>unit<span class="sc">==</span><span class="st">"meter"</span> <span class="sc">&amp;</span> units<span class="sc">$</span>measurement_type<span class="sc">==</span><span class="st">"length"</span>]</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>    cd_unit_m<span class="ot">&lt;-</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"INSERT INTO main.def_unit(cd_measurement_type,unit,unit_spa,abbv_unit,factor)</span></span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a><span class="st">VALUES((SELECT cd_measurement_type FROM main.def_measurement_type WHERE measurement_type = 'length')"</span>,<span class="st">","</span>,</span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"meter"</span>),<span class="st">","</span>,</span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"metro"</span>),<span class="st">","</span>,</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"m"</span>),<span class="st">","</span>,</span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="dv">1</span>),</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a><span class="st">") RETURNING cd_unit"</span>))<span class="sc">$</span>cd_unit</span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>  cd_var_height_m<span class="ot">&lt;-</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="fu">paste0</span>(<span class="st">"INSERT INTO main.def_var(cd_unit,cd_org_lev,name_var,description,extra_var,extension_dwc,type_var,repeatable) VALUES("</span>,</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,cd_unit_m),<span class="st">",</span></span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a><span class="st">(SELECT cd_org_lev FROM main.def_organisation_level WHERE org_lev='sub-individual characteristics'),"</span>,</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"height_m"</span>),<span class="st">","</span>,</span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"Height of a ramet"</span>),<span class="st">","</span>,</span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,T),<span class="st">","</span>,</span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">'MeasurementOrFact'</span>),<span class="st">","</span>,</span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,<span class="st">"double precision"</span>),<span class="st">","</span>,</span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,F),<span class="st">")</span></span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a><span class="st">RETURNING cd_var"</span></span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>    ))<span class="sc">$</span>cd_var</span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>cd_project<span class="ot">&lt;-</span>cd_projects</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="do">### </span><span class="al">TODO</span><span class="do">: manage that!</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>corrected_parcelas[<span class="dv">7954</span>,<span class="st">"ramet"</span>]<span class="ot">&lt;-</span><span class="dv">6</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>mat_ramet<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(corrected_parcelas[<span class="fu">c</span>(<span class="st">"plot"</span>,<span class="st">"subplot"</span>,<span class="st">"ind"</span>,<span class="st">"ramet"</span>)])</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>pbRamets<span class="ot">&lt;-</span><span class="fu">which</span>(<span class="sc">!</span><span class="fu">match</span>(<span class="fu">split</span>(mat_ramet,<span class="fu">row</span>(mat_ramet)),<span class="fu">split</span>(mat_ramet,<span class="fu">row</span>(mat_ramet)))<span class="sc">==</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mat_ramet))</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">length</span>(pbRamets)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a> {corrected_parcelas<span class="ot">&lt;-</span>corrected_parcelas[<span class="sc">-</span>pbRamets,]}</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="do">####</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>mat_ramet<span class="ot">&lt;-</span><span class="fu">as.matrix</span>(corrected_parcelas[<span class="fu">c</span>(<span class="st">"plot"</span>,<span class="st">"subplot"</span>,<span class="st">"ind"</span>,<span class="st">"ramet"</span>)])</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">match</span>(<span class="fu">split</span>(mat_ramet,<span class="fu">row</span>(mat_ramet)),<span class="fu">split</span>(mat_ramet,<span class="fu">row</span>(mat_ramet)))<span class="sc">==</span><span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mat_ramet))</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>cd_subind<span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a><span class="fu">dbBegin</span>(pp_bst)</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(corrected_parcelas))</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>  cd_subind<span class="ot">&lt;-</span>RPostgres<span class="sc">::</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="fu">paste0</span>(</span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"INSERT INTO main.subindividual(cd_ind,cd_part,part_number,uniq_in_project,tag) VALUES("</span>,</span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,corrected_parcelas<span class="sc">$</span>cd_ind[i]),<span class="st">","</span>,</span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,cd_part),<span class="st">","</span>,</span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,corrected_parcelas<span class="sc">$</span>ramet[i]),<span class="st">","</span>,</span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,corrected_parcelas<span class="sc">$</span>cd_project[i]),<span class="st">","</span>,</span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,corrected_parcelas<span class="sc">$</span>individualID[i]),<span class="st">"</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a><span class="st">    ) RETURNING cd_subind"</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>  ))<span class="sc">$</span>cd_subind</span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(corrected_parcelas<span class="sc">$</span>DBH_cm[i])){</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>  RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,<span class="fu">paste0</span>(</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"INSERT INTO main.subindividual_characteristics(cd_reg,cd_subind,cd_var,subind_char_double)</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a><span class="st">    VALUES("</span>,</span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,corrected_parcelas<span class="sc">$</span>cd_reg[i]),<span class="st">","</span>,</span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,cd_subind),<span class="st">","</span>,</span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,cd_var_dbh_cm),<span class="st">","</span>,</span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,corrected_parcelas<span class="sc">$</span>DBH_cm[i]),</span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span></span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.na</span>(corrected_parcelas<span class="sc">$</span>height_m[i])){</span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a>  RPostgres<span class="sc">::</span><span class="fu">dbExecute</span>(pp_bst,<span class="fu">paste0</span>(</span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"INSERT INTO main.subindividual_characteristics(cd_reg,cd_subind,cd_var,subind_char_double)</span></span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a><span class="st">    VALUES("</span>,</span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,corrected_parcelas<span class="sc">$</span>cd_reg[i]),<span class="st">","</span>,</span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,cd_subind),<span class="st">","</span>,</span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,cd_var_height_m),<span class="st">","</span>,</span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a>    RPostgres<span class="sc">::</span><span class="fu">dbQuoteLiteral</span>(pp_bst,corrected_parcelas<span class="sc">$</span>height_m[i]),</span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">")"</span></span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a>  corrected_parcelas<span class="sc">$</span>cd_subind[i] <span class="ot">&lt;-</span> cd_subind</span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a><span class="fu">dbCommit</span>(pp_bst)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="creating-the-occurrenceid" class="level2">
<h2 class="anchored" data-anchor-id="creating-the-occurrenceid">Creating the occurrenceID</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb79"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> cd_reg, project, <span class="st">'IAvH:OBSERVATIONHUMANA:'</span><span class="op">||</span><span class="fu">UPPER</span>(project)<span class="op">||</span><span class="st">'_CENSUS0:'</span><span class="op">||</span><span class="fu">LPAD</span>( (<span class="fu">ROW_NUMBER</span>() <span class="kw">OVER</span> (<span class="kw">PARTITION</span> <span class="kw">BY</span> cd_project <span class="kw">ORDER</span> <span class="kw">BY</span> cd_project,cd_reg)):<span class="ch">:text</span>,<span class="dv">4</span>,<span class="st">'0'</span>) occurence_id</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> main.register r</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> main.event e <span class="kw">USING</span> (cd_event)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> main.gp_event ge <span class="kw">USING</span> (cd_gp_event)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> main.project p <span class="kw">USING</span> (cd_project)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: left;">cd_reg</th>
<th style="text-align: left;">project</th>
<th style="text-align: left;">occurence_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">5141</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0001</td>
</tr>
<tr class="even">
<td style="text-align: left;">5142</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0002</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5143</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0003</td>
</tr>
<tr class="even">
<td style="text-align: left;">5144</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0004</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5145</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0005</td>
</tr>
<tr class="even">
<td style="text-align: left;">5146</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0006</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5147</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0007</td>
</tr>
<tr class="even">
<td style="text-align: left;">5148</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0008</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5149</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0009</td>
</tr>
<tr class="even">
<td style="text-align: left;">5150</td>
<td style="text-align: left;">Plato</td>
<td style="text-align: left;">IAvH:OBSERVATIONHUMANA:PLATO_CENSUS0:0010</td>
</tr>
</tbody>
</table>
<p>Displaying records 1 - 10</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>reg_occurrenceId<span class="ot">&lt;-</span><span class="fu">dbGetQuery</span>(pp_bst,<span class="st">"</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="st">WITH a AS(</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT cd_reg, project, 'IAvH:OBSERVATIONHUMANA:'||UPPER(project)||'_CENSUS0:'||LPAD( (ROW_NUMBER() OVER (PARTITION BY cd_project ORDER BY cd_project,cd_reg))::text,4,'0') occurrence_id</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="st">FROM main.register r</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.event e USING (cd_event)</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.gp_event ge USING (cd_gp_event)</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN main.project p USING (cd_project)</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="st">)UPDATE main.register AS r</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="st">SET occurrence_id=a.occurrence_id</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="st">FROM a</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="st">WHERE a.cd_reg=r.cd_reg AND r.occurrence_id IS NULL</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="st">RETURNING r.cd_reg, r.occurrence_id"</span>)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">is.na</span>(corrected_parcelas<span class="sc">$</span>occurrenceID)))</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>corrected_parcelas<span class="sc">$</span>occurrenceID<span class="ot">&lt;-</span>reg_occurrenceId<span class="sc">$</span>occurrence_id[<span class="fu">match</span>(corrected_parcelas<span class="sc">$</span>cd_reg,reg_occurrenceId<span class="sc">$</span>cd_reg)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="checking-final-quality" class="level2">
<h2 class="anchored" data-anchor-id="checking-final-quality">Checking final quality</h2>
<p>Most likely, the problems we will find here will be corrected in a previous part of the code, so the results here won’t show them anymore, but it is helpful to keep the checks here!</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb81"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WITH</span> a <span class="kw">AS</span>(</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> project,event_id,location, substring(event_id <span class="kw">FROM</span> <span class="st">'[0-9]+$'</span>) subplot_event, substring(location <span class="kw">FROM</span> <span class="st">'[0-9]+$'</span>) subplot_location</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> main.register_location rl</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> main.register <span class="kw">USING</span> (cd_reg)</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> main.event <span class="kw">USING</span> (cd_event)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> main.gp_event <span class="kw">USING</span> (cd_gp_event)</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> main.project <span class="kw">USING</span> (cd_project)</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="kw">LEFT</span> <span class="kw">JOIN</span> main.location l <span class="kw">ON</span> l.cd_org_lev<span class="op">=</span><span class="dv">6</span> <span class="kw">AND</span> ST_intersects(rl.pt_geom,l.pol_geom) </span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>),b <span class="kw">AS</span>(</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> project,subplot_event,subplot_location,<span class="fu">count</span>(<span class="op">*</span>)</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> a</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="kw">GROUP</span> <span class="kw">BY</span> project,subplot_event,subplot_location</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>),c <span class="kw">AS</span>(</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> <span class="kw">ON</span> (project,subplot_event) project, subplot_event, subplot_location</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> b</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> project,subplot_event,<span class="fu">count</span> <span class="kw">DESC</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> c</span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> subplot_event<span class="op">&lt;&gt;</span>subplot_location</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;">project</th>
<th style="text-align: left;">subplot_event</th>
<th style="text-align: left;">subplot_location</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>0 records</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(corrected_parcelas,<span class="at">file=</span><span class="st">"../../inserted_3parcelas_backup.RData"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="shutting-down-light" class="level2">
<h2 class="anchored" data-anchor-id="shutting-down-light">Shutting down light…</h2>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dbDisconnect</span>(pp_bst)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>